# トヨタセールスAIアシスタント 基本設計書

## 1. システム概要

### 目的と範囲
本システムは、トヨタ自動車の営業担当者が生成AIを活用して、顧客情報から最適な提案内容とセールストークを生成するためのツールです。営業担当者の商談準備の効率化と顧客へのより適切な提案を可能にします。

### 主要機能の一覧
1. **顧客情報入力機能**
   - テキスト入力による顧客情報登録
   - 音声ファイルからのテキスト抽出と情報登録

2. **提案内容生成機能**
   - 顧客情報に基づく最適な車種提案
   - 支払方法の提案と詳細説明
   - 下取車両の査定と提案

3. **Q&A機能**
   - 想定質問と回答例の表示
   - カスタム質問の入力と回答生成

4. **ロールプレイ機能**
   - セールストークの生成
   - ロールプレイ練習環境の提供

5. **履歴管理機能**
   - 提案内容の保存
   - 提案履歴の検索と閲覧

## 2. 画面設計

### 画面一覧と画面仕様

#### 1. ログイン画面
- **目的**: ユーザー認証
- **主要コンポーネント**:
  - ユーザー名入力フィールド
  - パスワード入力フィールド
  - ログインボタン
  - ロゴ表示領域

#### 2. 顧客情報入力画面
- **目的**: 顧客基本情報の入力
- **主要コンポーネント**:
  - 顧客名/ID入力フィールド（必須）
  - 顧客タイプ選択ラジオボタン
  - 顧客情報詳細テキストエリア
  - 音声ファイル入力と処理機能
  - 提案内容生成ボタン

#### 3. 提案内容画面
- **目的**: 生成された提案内容の表示
- **主要コンポーネント**:
  - 顧客情報サマリー
  - 提案車種と詳細情報
  - 支払方法の提案と詳細
  - 下取対応の詳細
  - 想定質問と回答例
  - Q&A入力と回答表示
  - ロールプレイ開始ボタン
  - 履歴保存ボタン

#### 4. ロールプレイ画面
- **目的**: セールストークの表示とロールプレイ練習
- **主要コンポーネント**:
  - 推奨セールストーク表示
  - ロールプレイ練習ボタン
  - 履歴保存ボタン
  - 前画面に戻るボタン

#### 5. 履歴画面
- **目的**: 過去の提案内容の管理
- **主要コンポーネント**:
  - 検索・フィルター機能
  - 履歴一覧表示
  - 履歴詳細表示
  - ページネーション
  - CSVエクスポート機能

#### 6. 設定画面（モーダル）
- **目的**: システム設定の管理
- **主要コンポーネント**:
  - API設定項目
  - ロールプレイURL設定
  - 接続テスト機能
  - 設定保存ボタン
  - デフォルト設定に戻すボタン

### 状態遷移と条件分岐

#### 画面遷移フロー
1. **ログイン画面** → **顧客情報入力画面**（認証成功時）
2. **顧客情報入力画面** → **提案内容画面**（提案生成ボタン押下時）
3. **提案内容画面** → **ロールプレイ画面**（ロールプレイ開始ボタン押下時）
4. **ロールプレイ画面** → **提案内容画面**（前画面に戻るボタン押下時）
5. **任意の画面** → **履歴画面**（ナビゲーションタブ押下時）
6. **任意の画面** → **設定画面**（設定ボタン押下時）
7. **任意の画面** → **ログイン画面**（ログアウトボタン押下時）

#### 条件分岐
1. **ログイン処理**:
   - 認証成功: 顧客情報入力画面へ遷移
   - 認証失敗: エラーメッセージ表示

2. **提案内容生成処理**:
   - 顧客名入力あり: 提案内容生成を実行
   - 顧客名入力なし: エラーメッセージ表示
   - 顧客情報詳細入力なし: 警告メッセージ表示

3. **Q&A処理**:
   - 質問入力あり: 回答を生成して表示
   - 質問入力なし: 警告メッセージ表示

4. **音声ファイル処理**:
   - ファイル選択あり: 処理開始
   - ファイル選択なし: エラーメッセージ表示

### 入出力項目の詳細定義

#### 顧客情報入力画面
| 項目名 | 種類 | 必須 | 形式 | 説明 |
|-------|------|------|------|------|
| 顧客名/ID | テキスト | ○ | 最大100文字 | 顧客を識別するための名前またはID |
| 顧客タイプ | ラジオボタン | ○ | 単一選択 | 購入意思の有無と車種選定状況 |
| 顧客情報詳細 | テキストエリア | - | 最大5000文字 | 年齢、家族構成、趣味など詳細情報 |
| 音声ファイル | ファイル | - | MP3/WAV/M4A | 商談内容などの音声記録 |

#### 提案内容画面 - Q&A
| 項目名 | 種類 | 必須 | 形式 | 説明 |
|-------|------|------|------|------|
| 質問 | テキスト | ○ | 最大500文字 | ユーザーからの質問内容 |
| 回答 | テキスト | - | 自動生成 | AIによる回答内容 |

#### 設定画面
| 項目名 | 種類 | 必須 | 形式 | 説明 |
|-------|------|------|------|------|
| Dify APIキー | パスワード | ○ | 固定長文字列 | Dify APIの認証キー |
| APIエンドポイント | テキスト | ○ | URL | Dify APIのエンドポイント |
| セールス役URL | テキスト | ○ | URL | ロールプレイのセールス役URL |
| 顧客役URL | テキスト | ○ | URL | ロールプレイの顧客役URL |

### バリデーションルール

#### 顧客情報入力
1. **顧客名/ID**:
   - 必須入力チェック
   - 最大100文字制限

2. **顧客情報詳細**:
   - 最大5000文字制限
   - 空欄時は警告表示（エラーではない）

3. **音声ファイル**:
   - 対応形式（MP3/WAV/M4A）チェック
   - 最大ファイルサイズ制限（50MB）

#### Q&A入力
1. **質問**:
   - 必須入力チェック
   - 最大500文字制限

#### 設定入力
1. **APIキー**:
   - 必須入力チェック
   - 形式チェック（適切な長さとパターン）

2. **APIエンドポイント**:
   - 必須入力チェック
   - URL形式チェック

3. **ロールプレイURL**:
   - 必須入力チェック
   - URL形式チェック

## 3. Dify API仕様

### エンドポイント一覧

#### 1. 音声テキスト変換 API
- **エンドポイント**: `/v1/audio-to-text`
- **メソッド**: POST
- **認証**: Bearer Token (APIキー)
- **機能**: 音声ファイルからテキストを抽出

#### 2. 提案内容生成 API
- **エンドポイント**: `/v1/generate-proposal`
- **メソッド**: POST
- **認証**: Bearer Token (APIキー)
- **機能**: 顧客情報から最適な提案内容を生成

#### 3. 質問応答 API
- **エンドポイント**: `/v1/qa`
- **メソッド**: POST
- **認証**: Bearer Token (APIキー)
- **機能**: 質問に対する回答を生成

#### 4. ロールプレイ API
- **エンドポイント**: `/v1/roleplay`
- **メソッド**: POST
- **認証**: Bearer Token (APIキー)
- **機能**: ロールプレイのセッション管理とデータ生成

### リクエスト/レスポンス構造

#### 1. 音声テキスト変換 API

**リクエスト**:
```json
{
  "audio_file": "[Base64エンコードされた音声ファイル]",
  "file_format": "mp3|wav|m4a",
  "language": "ja"
}
```

**レスポンス**:
```json
{
  "status": "success|processing|error",
  "text": "抽出されたテキスト内容",
  "progress": 100,
  "error": "エラーメッセージ（エラー時のみ）"
}
```

#### 2. 提案内容生成 API

**リクエスト**:
```json
{
  "customer_name": "山田太郎",
  "customer_type": "no-intent|no-intent-interest|intent-undecided",
  "customer_details": "年齢、家族構成、趣味・ライフスタイルなどの詳細情報"
}
```

**レスポンス**:
```json
{
  "status": "success|error",
  "customer_summary": {
    "name": "山田太郎",
    "age": 35,
    "gender": "男性",
    "family": "妻、子供2人（5歳・2歳）",
    "purchase_intent": "ある程度あり・車種は白紙"
  },
  "car_proposal": {
    "name": "シエンタ",
    "grade": "G",
    "price_range": "270万円～",
    "reasons": ["家族4人での使用に適した3列シート", "子供の成長に合わせて長く使える実用性", "燃費性能の良さと経済性"],
    "image_url": "https://example.com/images/sienta.jpg"
  },
  "payment_proposal": {
    "type": "残価設定型クレジット",
    "monthly_payment": 35000,
    "down_payment": 500000,
    "term": 60,
    "bonus_payment": 100000,
    "residual_value": 1100000,
    "interest_rate": 2.9,
    "reasons": ["子供の教育費増加を見据えた家計計画", "5年後の買い替えニーズに対応", "月々の支払いを抑えながら新車に乗れる"]
  },
  "trade_in_details": {
    "vehicle": "スズキ ワゴンR（2015年式）",
    "appraisal_amount": 450000,
    "campaign_bonus": 50000,
    "price_after_trade_in": 2200000,
    "benefits": ["名義変更や廃車手続きの手間が不要", "新車の頭金に充当可能", "現在実施中の下取りキャンペーンで査定額アップ"]
  },
  "expected_qa": [
    {
      "question": "維持費はどれくらいかかりますか？",
      "answer": "シエンタは燃費が良く、年間の維持費は同クラスの中でも経済的です。燃費は約20km/Lですので、年間走行距離10,000kmの場合、燃料費は約7万円程度です。また、定期点検や保険なども含めると年間15〜20万円程度を目安にしていただくと良いでしょう。"
    },
    {
      "question": "子供が大きくなっても使えますか？",
      "answer": "はい、3列目シートは十分な広さがあり、お子様が小学生、中学生になっても快適にお使いいただけます。また、シートアレンジも豊富で、お子様の成長に合わせて荷物が増えた場合にも対応できる実用性の高さが特徴です。"
    }
  ],
  "sales_talk": "山田様、今日はお子様連れでのご来店、ありがとうございます。お子様の年齢を伺うと、シエンタが最適かと思います。特に3列シートは、お子様の成長に合わせて長く快適にお使いいただけます。また、燃費性能も優れているので、経済的にもメリットがあります。お子様の教育費が増えていく時期に、維持費を抑えられる点もおすすめポイントです。残価設定型クレジットであれば、月々の支払いを抑えながら、お子様の成長に合わせて5年後に買い替えることも可能です。",
  "error": "エラーメッセージ（エラー時のみ）"
}
```

#### 3. 質問応答 API

**リクエスト**:
```json
{
  "question": "燃費性能はどうですか？",
  "context": {
    "car_name": "シエンタ",
    "customer_summary": "...",
    "proposal_details": "..."
  }
}
```

**レスポンス**:
```json
{
  "status": "success|error",
  "answer": "シエンタの燃費性能は、ハイブリッドモデルで約25km/Lと非常に優れています。これは同クラスのミニバンでトップクラスの数値で、年間の燃料費を大幅に抑えることができます。また、CO2排出量も少なく、環境にも優しい車です。",
  "error": "エラーメッセージ（エラー時のみ）"
}
```

## 4. データ構造設計

### データエンティティとリレーション

#### エンティティ一覧

1. **ユーザー**
   - ユーザーID (PK)
   - ユーザー名
   - パスワード（ハッシュ化）
   - 権限レベル
   - 最終ログイン日時

2. **顧客**
   - 顧客ID (PK)
   - 顧客名
   - 顧客タイプ
   - 顧客情報詳細
   - 作成日時
   - 更新日時

3. **提案**
   - 提案ID (PK)
   - 顧客ID (FK)
   - ユーザーID (FK)
   - 提案車種
   - 支払方法
   - 下取情報
   - セールストーク
   - 作成日時
   - 更新日時

4. **質問応答**
   - 質問応答ID (PK)
   - 提案ID (FK)
   - 質問内容
   - 回答内容
   - 作成日時

5. **設定**
   - 設定ID (PK)
   - ユーザーID (FK)
   - APIキー（暗号化）
   - APIエンドポイント
   - セールス役URL
   - 顧客役URL
   - 更新日時

#### リレーション
- ユーザー 1:N 提案（一人のユーザーが複数の提案を作成）
- 顧客 1:N 提案（一人の顧客に対して複数の提案が存在可能）
- 提案 1:N 質問応答（一つの提案に対して複数の質問応答）
- ユーザー 1:1 設定（一人のユーザーに一つの設定）

### データの永続化方針

#### プロトタイプ段階
- ローカルストレージ（WebStorage API）を使用したデータ保存
- セッションごとの一時データはセッションストレージに保存
- 設定やログイン情報などの永続的データはローカルストレージに保存

#### 本番環境
- 関係データベース（MySQL/PostgreSQL）を使用したバックエンド保存
- 機密データ（APIキー、パスワード）の暗号化保存
- レプリケーションとバックアップ戦略の実装

## 5. 開発指針

### 技術スタック
- **バックエンド**: Flask（Python）
- **データベース**: SQLite
- **フロントエンド**: HTML/CSS/Javascript

### バックエンド実装方針

#### Flaskフレームワーク設計
- **MVCパターン**: Model-View-Controller パターンに基づく設計
- **Blueprint**: 機能ごとにモジュール化した構造
- **RESTful API**: RESTful原則に従ったAPI設計
- **ORM**: SQLAlchemyを使用したデータベースアクセス

#### SQLiteデータベース管理
- **マイグレーション**: Flask-Migrateを用いたスキーマ管理
- **データアクセス層**: リポジトリパターンに基づくデータアクセス実装
- **トランザクション管理**: 整合性を維持するためのトランザクション制御

#### サーバサイド処理
- **認証・認可**: Flask-Loginによるユーザー認証管理
- **バリデーション**: WTFormsを用いた入力検証
- **エラーハンドリング**: 一貫性のあるエラー処理とロギング
- **Dify API連携**: APIクライアントとリクエスト管理

### フロントエンド実装方針

#### HTML/CSS
- **セマンティックHTML**: HTML5の標準に準拠した構造化
- **CSSフレームワーク**: 独自スタイルシートと変数の活用
- **レスポンシブデザイン**: モバイルからデスクトップまで対応
- **アクセシビリティ**: WAI-ARIAに準拠したマークアップ

#### JavaScript
- **モジュール化**: 機能ごとのJSモジュール分割
- **フェッチAPI**: サーバーとの非同期通信の実装
- **DOM操作**: クライアントサイドでの動的UI更新
- **イベント管理**: ユーザーインタラクションの適切な処理

#### UI/UXガイドライン
- **デザインシステム**: トヨタブランドカラー（赤:#E50012、ダークブルー:#0F2B5B）の一貫した使用
- **レスポンシブ設計**: モバイルファーストアプローチ
- **アニメーション**: 適切なトランジションと視覚フィードバック
- **ローディング状態**: 処理中の適切なフィードバック

#### パフォーマンス最適化
- **遅延読み込み**: 必要に応じたリソースの遅延読み込み
- **キャッシュ戦略**: 静的リソースの効率的キャッシュ
- **圧縮**: 画像と静的アセットの最適化

### コーディング規約の提案

#### Python/Flask
- PEP 8スタイルガイドに準拠
- 適切なドキュメント文字列（Docstrings）の記述
- タイプヒントの活用
- 単体テストによるコードの検証

#### HTML
- セマンティックHTMLの使用（nav, section, article, headerなど）
- アクセシビリティに配慮した属性の追加（aria-* 属性）
- コメントを用いた大きなセクションの区切り
- Jinja2テンプレートの適切な活用

#### CSS
- BEM（Block Element Modifier）命名規則の採用
- 変数を使用したカラーパレットと間隔の一貫性
- メディアクエリを用いたレスポンシブデザインの実装

#### JavaScript
- ES6+ の記法を使用（アロー関数、テンプレートリテラルなど）
- 関数の単一責任原則に従った実装
- イベントリスナーの適切な管理（メモリリーク防止）
- コメントによるAPI連携部分の明確な説明

#### バージョン管理
- 機能単位でのブランチ作成とマージ
- 意味のあるコミットメッセージの使用
- プルリクエストによるコードレビュープロセス

## 6. 開発・実装の注意点

### セキュリティ対策
1. **APIキー管理**:
   - クライアント側でのAPIキー漏洩防止策の実装
   - APIキーのローテーション機能の検討

2. **入力検証**:
   - すべてのユーザー入力に対する適切なバリデーション
   - XSSやCSRF攻撃への対策実装

3. **認証と認可**:
   - セキュアなログインプロセスの実装
   - 適切な権限管理と認可チェック

### 性能最適化
1. **API呼び出し最適化**:
   - 不必要なAPI呼び出しの削減
   - バックグラウンド処理とキャッシュ戦略の実装

2. **ユーザー体験**:
   - 長時間処理中のローディングインジケータ表示
   - エラー発生時の適切なユーザーフィードバック

### 拡張性と保守性
1. **モジュール設計**:
   - 機能ごとに独立したモジュール化
   - 共通コンポーネントの再利用

2. **設定の外部化**:
   - ハードコードされた値の排除
   - 環境変数や設定ファイルの活用

3. **デバッグとログ**:
   - 適切なログ記録の実装
   - トラブルシューティングのための診断情報の提供

### 将来の拡張計画への対応
1. **多言語対応**:
   - テキストリソースの外部化
   - 言語切り替え機能の基盤実装

2. **暗いテーマ対応**:
   - CSSの変数を活用したカラーテーマ管理
   - ユーザー設定の保存機能

3. **データベース連携**:
   - 将来的なデータベース移行を見据えたデータアクセス層の抽象化
   - マイグレーション戦略の検討 